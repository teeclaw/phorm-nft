# 2026-02-13

## openclaw-8004 Skill â€” ERC-8004 Telegram Inline Button Panel

### Final State: v3.2.0
- **Clean rebuild** from v2.x mess (user called out the clutter)
- 10 scripts, 2 core files: `menu-config.js` + `handle-command.js`
- Official ABIs saved in `abis/` from `erc-8004/erc-8004-contracts` repo

### Architecture
```
scripts/
â”œâ”€â”€ menu-config.js      # Menu definitions (static text + buttons)
â”œâ”€â”€ handle-command.js   # Router + Telegram API (dynamic content)
â”œâ”€â”€ send-panel.js       # Entry point (calls handle /8004_main)
â”œâ”€â”€ get-agent-info.js   # Main panel summary (owner, profile, reputation)
â”œâ”€â”€ view-profile.js     # Full profile decoder (base64 â†’ readable, --raw for JSON)
â”œâ”€â”€ register-agent.js   # Minimal (name|desc|image) or Full (--uri data:...)
â”œâ”€â”€ update-metadata.js  # Takes JSON, encodes base64, calls setAgentURI()
â”œâ”€â”€ transfer-ownership.js # ERC-721 transferFrom
â”œâ”€â”€ give-feedback.js    # giveFeedback() per EIP-8004 spec
â”œâ”€â”€ search-feedback.js  # getClients() â†’ getSummary() â†’ readAllFeedback()
abis/
â”œâ”€â”€ IdentityRegistry.json   # Official ABI (source of truth)
â”œâ”€â”€ ReputationRegistry.json # Official ABI (source of truth)
```

### Menu Flow (3 layers max)
```
Layer 1: Main Panel (live agent summary + 4 buttons)
â”œâ”€â”€ ğŸ” View Profile â†’ full decoded profile + [Update] [Back]
â”œâ”€â”€ âš™ï¸ Manage (Layer 2)
â”‚   â”œâ”€â”€ ğŸ“ Register â†’ [âš¡ Minimal] [ğŸ“‹ Full JSON template]
â”‚   â”œâ”€â”€ âœï¸ Update â†’ downloads current profile.json + paste instructions
â”‚   â””â”€â”€ ğŸ”€ Transfer â†’ danger warning + address input
â”œâ”€â”€ â­ Reputation (Layer 2)
â”‚   â”œâ”€â”€ âœï¸ Rate an Agent â†’ score 0-100 + tags
â”‚   â””â”€â”€ ğŸ” Look Up Agent â†’ shows feedback + [Rate This Agent]
â””â”€â”€ ğŸ”— Links â†’ URL buttons (BaseScan, 8004agents.ai, EIP spec)
```

### UX Principles Applied
- Every response has navigation buttons (no dead ends)
- Loading states: `â³ Registering...` / `â³ Updating...`
- Error recovery: clear error message + [Try Again] button
- Dynamic links (agent ID from env, not hardcoded)
- Plain text (no Markdown) to avoid Telegram parsing issues with URLs
- Update flow sends downloadable JSON file
- Register offers Minimal (text) or Full (JSON template)

### Correct EIP-8004 Function Names (from official ABIs)
**Identity Registry:**
- `register(string agentURI)` â€” mint new agent
- `setAgentURI(uint256 agentId, string newURI)` â€” update profile
- `setMetadata(uint256 agentId, string key, bytes value)` â€” key-value metadata
- `setAgentWallet(uint256 agentId, address, uint256 deadline, bytes sig)` â€” EIP-712
- `transferFrom(from, to, tokenId)` â€” ERC-721 transfer
- `ownerOf`, `tokenURI`, `getAgentWallet`, `getMetadata`

**Reputation Registry:**
- `giveFeedback(agentId, value, valueDecimals, tag1, tag2, endpoint, feedbackURI, feedbackHash)`
- `revokeFeedback(agentId, feedbackIndex)`
- `getClients(agentId)` â†’ `getSummary(agentId, clients[], tag1, tag2)` â†’ `readAllFeedback(...)`
- `readFeedback(agentId, clientAddress, feedbackIndex)`

### Key Decisions
- **Data URI only** â€” all profiles stored fully on-chain (base64), no HTTP URLs
- **Gas is cheap** â€” no cost warnings, especially on Base
- **viem + ABI** â€” no SDK dependencies
- **GPG-encrypted private key** â€” decrypted in-memory only

### Lessons Learned
- Don't incrementally patch â€” rebuild when messy
- Telegram MarkdownV2 breaks with URLs â€” use plain text
- `getSummary()` needs `clientAddresses[]` â€” call `getClients()` first
- OpenClaw doesn't pass message_id in callbacks â€” can't edit, only send new messages
